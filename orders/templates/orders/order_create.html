{# orders/templates/orders/order_create.html #}
{% extends "base.html" %}

{% block title %}{{ page_title|default:"Create Order" }}{% endblock %}

{% block content %}
<h1 class="mb-4">{{ page_title|default:"Create Order" }}</h1>

{# Use Bootstrap Grid for layout #}
<div class="row g-5"> {# Gutters for spacing #}

  {# Left Column: Customer & Items #}
  <div class="col-md-7 col-lg-8">
    <h4 class="mb-3">Customer & Items</h4>

    {# 1. Customer Selection (Placeholder) #}
    <div class="mb-4 p-3 border rounded">
        <h5>1. Select Customer</h5>
        <div class="input-group">
            <input type="text" class="form-control" placeholder="Search Customer (Name, Phone...)" id="customer-search-input">
            <button class="btn btn-outline-secondary" type="button" id="add-customer-btn">Add New</button>
        </div>
        <div id="customer-search-results" class="list-group mt-2" style="max-height: 150px; overflow-y: auto;">
            <!-- Search results will appear here -->
        </div>
        <div id="selected-customer-info" class="mt-2 text-success fw-bold">
            <!-- Selected customer details -->
        </div>
        <input type="hidden" id="selected-customer-id" name="customer_id"> {# Hidden field to store ID #}
    </div>

    {# 2. Order Items (Placeholder) #}
    <div class="mb-4 p-3 border rounded">
        <h5>2. Add Products</h5>
        <div class="input-group mb-3">
             <input type="text" class="form-control" placeholder="Search Product (Name, Category...)" id="product-search-input">
        </div>
         <div id="product-search-results" class="list-group mb-3" style="max-height: 150px; overflow-y: auto;">
            <!-- Product Search results will appear here -->
        </div>

        <h6>Current Items</h6>
        <div class="table-responsive">
            <table class="table" id="order-items-table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th style="width: 15%;">Price</th>
                        <th style="width: 15%;">Quantity</th>
                        <th style="width: 15%;">Total</th>
                        <th style="width: 5%;"></th> {# Delete button col #}
                    </tr>
                </thead>
                <tbody>
                    {# Order items will be added here by JavaScript #}
                    <tr id="no-items-row">
                        <td colspan="5" class="text-center text-muted">No items added yet.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

  </div>{# End Left Column #}

  {# Right Column: Summary & Payment #}
  <div class="col-md-5 col-lg-4 order-md-last"> {# order-md-last pushes this right on medium+ screens #}
    <h4 class="d-flex justify-content-between align-items-center mb-3">
      <span class="text-primary">Order Summary</span>
      {# Maybe item count badge later #}
      {# <span class="badge bg-primary rounded-pill">3</span> #}
    </h4>
    <ul class="list-group mb-3">
      <li class="list-group-item d-flex justify-content-between lh-sm">
        <div>
          <h6 class="my-0">Subtotal</h6>
        </div>
        <span class="text-muted" id="summary-subtotal">₹0.00</span>
      </li>
      <li class="list-group-item d-flex justify-content-between lh-sm">
        <div>
          <h6 class="my-0">Discount</h6>
        </div>
         {# Discount Input #}
         <span class="text-muted">
            <input type="number" class="form-control form-control-sm text-end" id="discount-input" value="0" min="0" step="0.01" style="width: 80px;">
         </span>
      </li>
      {% comment %} TAX LINE placeholder - add later if needed {% endcomment %}
      <li class="list-group-item d-flex justify-content-between lh-sm">
        <div><h6 class="my-0">Tax</h6></div><span class="text-muted" id="summary-tax">₹0.00</span>
      </li>
      
      <li class="list-group-item d-flex justify-content-between">
        <span>Total (INR)</span>
        <strong id="summary-total">₹0.00</strong>
      </li>
    </ul>

    {# Payment Section (Placeholder) #}
    <div class="p-3 border rounded">
        <h5 class="mb-3">Payment</h5>
         <div class="mb-3">
            <label for="payment-method" class="form-label">Payment Method</label>
             <div class="input-group">
                <select class="form-select" id="payment-method">
                    <option value="" selected>-- Select Method --</option>
                    {# Options will be loaded later #}
                </select>
                <button class="btn btn-outline-secondary btn-sm" type="button" id="add-payment-method-btn">Add New</button>
            </div>
        </div>
         <div class="mb-3">
            <label for="amount-paid" class="form-label">Amount Paid</label>
            <input type="number" class="form-control" id="amount-paid" value="0.00" min="0" step="0.01">
        </div>
        <div class="mb-3">
             <label for="payment-status" class="form-label">Payment Status</label>
             <select class="form-select" id="payment-status">
                 <option value="Pending">Pending</option>
                 <option value="Partial">Partial</option>
                 <option value="Paid">Paid</option>
             </select>
        </div>
         <div class="mb-3">
             <label for="payment-reference" class="form-label">Payment Reference</label>
             <input type="text" class="form-control form-control-sm" id="payment-reference" placeholder="(Optional) e.g., UPI ID, Txn No.">
        </div>
         <hr>
         <div class="mb-3">
             <label for="order-status" class="form-label">Order Status</label>
             <select class="form-select" id="order-status">
                 <option value="Pending" selected>Pending</option>
                 <option value="Processing">Processing</option>
                 <option value="Completed">Completed</option>
             </select>
         </div>

         <button class="w-100 btn btn-success btn-lg" type="button" id="create-order-btn">Create Order</button>

    </div>

  </div>{# End Right Column #}
</div> {# End Row #}

{# Bootstrap Modals (Hidden by default) #}
{# Add Customer Modal Placeholder #}
<div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addCustomerModalLabel">Add New Customer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="add-customer-modal-body">
        <!-- Customer form will be loaded here -->
         Loading form...
      </div>
      {# Footer might have save button handled by loaded form/JS #}
    </div>
  </div>
</div>

{# Add Payment Method Modal Placeholder #}
<div class="modal fade" id="addPaymentMethodModal" tabindex="-1" aria-labelledby="addPaymentMethodModalLabel" aria-hidden="true">
   <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addPaymentMethodModalLabel">Add New Payment Method</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
       <div class="modal-body" id="add-payment-method-modal-body">
            <label for="new-payment-method-name" class="form-label">Method Name:</label>
            <input type="text" id="new-payment-method-name" class="form-control mb-2">
            <button type="button" class="btn btn-primary" id="save-new-payment-method-btn">Save Method</button>
            <div id="payment-method-modal-error" class="text-danger mt-2"></div>
       </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Wait for the DOM to be fully loaded before running script
document.addEventListener('DOMContentLoaded', function() {

    // --- Customer Selection Elements ---
    const customerSearchInput = document.getElementById('customer-search-input');
    const customerSearchResultsDiv = document.getElementById('customer-search-results');
    const selectedCustomerInfoDiv = document.getElementById('selected-customer-info');
    const selectedCustomerIdInput = document.getElementById('selected-customer-id');
    const addCustomerBtn = document.getElementById('add-customer-btn');
    const addCustomerModalEl = document.getElementById('addCustomerModal');
    const addCustomerModalBody = document.getElementById('add-customer-modal-body');

    // Initialize Bootstrap Modal instance (requires Bootstrap JS loaded)
    let addCustomerModalInstance = null;
    if (addCustomerModalEl) {
        addCustomerModalInstance = new bootstrap.Modal(addCustomerModalEl);
    } else {
        console.error("Add Customer Modal element not found!");
    }

    // --- Customer Search Logic ---
    let customerSearchTimeout; // Used for debouncing search requests
    customerSearchInput.addEventListener('input', function() {
        clearTimeout(customerSearchTimeout);
        const query = this.value.trim();

        customerSearchResultsDiv.innerHTML = ''; // Clear previous results
        if (query.length < 2) { // Don't search for very short strings
            customerSearchResultsDiv.style.display = 'none';
            return;
        }

        // Wait 300ms after user stops typing
        customerSearchTimeout = setTimeout(() => {
            fetch(`/api/customers/search/?q=${encodeURIComponent(query)}`)
                .then(response => {
                    if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                    return response.json();
                 })
                .then(data => {
                    displayCustomerResults(data.results);
                })
                .catch(error => {
                    console.error('Error fetching customer search results:', error);
                    customerSearchResultsDiv.innerHTML = '<div class="list-group-item text-danger">Error loading results.</div>';
                    customerSearchResultsDiv.style.display = 'block';
                });
        }, 300);
    });

    // Function to display customer search results
    function displayCustomerResults(customers) {
        customerSearchResultsDiv.innerHTML = ''; // Clear previous results
        if (customers && customers.length > 0) {
            customers.forEach(customer => {
                const item = document.createElement('a');
                item.href = '#';
                item.classList.add('list-group-item', 'list-group-item-action', 'customer-result-item');
                item.textContent = customer.text; // Display text from API
                item.dataset.customerId = customer.id; // Store ID

                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    selectCustomer(customer.id, customer.text);
                });
                customerSearchResultsDiv.appendChild(item);
            });
            customerSearchResultsDiv.style.display = 'block';
        } else {
            customerSearchResultsDiv.innerHTML = '<div class="list-group-item text-muted">No customers found.</div>';
            customerSearchResultsDiv.style.display = 'block';
        }
    }

    // Function to handle selecting a customer from search results
    function selectCustomer(customerId, customerText) {
        selectedCustomerInfoDiv.textContent = `Selected: ${customerText}`;
        selectedCustomerIdInput.value = customerId; // Set hidden input value
        customerSearchInput.value = ''; // Clear search input
        customerSearchResultsDiv.innerHTML = ''; // Clear results list
        customerSearchResultsDiv.style.display = 'none'; // Hide results list
    }

    // --- Add Customer Modal Logic ---
    addCustomerBtn.addEventListener('click', function() {
        if (!addCustomerModalInstance) {
             console.error("Cannot open Add Customer modal, instance not found.");
             alert("Modal functionality error. Check console.");
             return;
        }

        // Fetch the customer form HTML fragment
        fetch("{% url 'customers:customer_add_form_htmx' %}")
            .then(response => {
                 if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                 return response.text();
             })
            .then(html => {
                addCustomerModalBody.innerHTML = html; // Load form HTML into modal
                clearModalErrors(); // Clear any previous errors before showing
                addCustomerModalInstance.show(); // Show the modal
                attachModalFormSubmitListener(); // Set up listener for the form inside the modal
            })
            .catch(error => {
                console.error("Error fetching or showing customer form:", error);
                addCustomerModalBody.innerHTML = '<p class="text-danger">Could not load customer form. Please try again.</p>';
                addCustomerModalInstance.show(); // Still show modal to display error
            });
    });

    // Function to attach the submit listener to the form *inside* the modal
    function attachModalFormSubmitListener() {
        const modalForm = addCustomerModalBody.querySelector('form');
        if (modalForm) {
            modalForm.addEventListener('submit', function(e) {
                e.preventDefault(); // Stop default page reload
                clearModalErrors(); // Clear previous errors

                const formData = new FormData(modalForm);

                // Send form data asynchronously to the API endpoint
                fetch("{% url 'customers:customer_add_modal_api' %}", {
                    method: 'POST',
                    body: formData,
                    headers: { // Required for Django POST requests
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                })
                .then(response => response.json()) // Expect JSON response
                .then(data => {
                    if (data.success) {
                        addCustomerModalInstance.hide(); // Close modal on success
                        selectCustomer(data.customer_id, data.customer_text); // Select the new customer
                        addCustomerModalBody.innerHTML = 'Loading form...'; // Reset modal body for next time
                    } else {
                        // Display validation errors returned from the server
                        displayModalErrors(data.errors);
                    }
                })
                .catch(error => {
                    console.error('Error submitting modal form:', error);
                    // Display a generic error message inside the modal
                     const nonFieldErrorDiv = document.getElementById('customer-modal-non-field-errors');
                     if(nonFieldErrorDiv) nonFieldErrorDiv.textContent = 'An unexpected error occurred. Please try again.';
                });
            });
        } else {
            console.error("Could not find form inside modal body to attach listener.");
        }
    }

    // Function to display validation errors inside the modal form
    function displayModalErrors(errors) {
        // General (non-field) errors
        if (errors.__all__) {
             const nonFieldErrorDiv = document.getElementById('customer-modal-non-field-errors');
             if(nonFieldErrorDiv) nonFieldErrorDiv.textContent = errors.__all__.join('; ');
        }
        // Field-specific errors
        for (const fieldName in errors) {
            if (fieldName !== '__all__') {
                const errorDiv = document.getElementById(`error_id_${fieldName}`);
                const inputField = addCustomerModalBody.querySelector(`[name="${fieldName}"]`);
                if (errorDiv) {
                    errorDiv.textContent = errors[fieldName].join('; '); // Show errors
                }
                if (inputField) {
                    inputField.classList.add('is-invalid'); // Add red border to field
                }
            }
        }
    }

    // Function to clear validation errors from the modal form
    function clearModalErrors() {
         const nonFieldErrorDiv = document.getElementById('customer-modal-non-field-errors');
         if(nonFieldErrorDiv) nonFieldErrorDiv.textContent = '';
         const errorDivs = addCustomerModalBody.querySelectorAll('.invalid-feedback');
         errorDivs.forEach(div => div.textContent = '');
         const invalidInputs = addCustomerModalBody.querySelectorAll('.is-invalid');
         invalidInputs.forEach(input => input.classList.remove('is-invalid'));
    }


    // --- Product Search Logic (Placeholder) ---
    // TODO: Add similar logic for product search input, results, and selection


    // --- Order Items Logic (Placeholder) ---
    // TODO: Add logic to add product rows to the table, handle quantity changes, row deletion


    // --- Order Summary Calculation Logic (Placeholder) ---
    // TODO: Add logic to calculate Subtotal, handle Discount, calculate Total


    // --- Payment Method Logic (Placeholder) ---
    // TODO: Load payment methods, handle 'Add New' modal for payment methods


    // --- Final Order Submission Logic ---
    document.getElementById('create-order-btn').addEventListener('click', function() {
        console.log("Create Order button clicked!");
        // TODO: 1. Gather data: customerId, items array [{product_id, quantity, price}], discount, payment_method_id, amount_paid, statuses etc.
        // TODO: 2. Client-side validation (e.g., at least one item selected?)
        // TODO: 3. Send data via fetch POST to a new backend endpoint (e.g., /orders/api/create/)
        // TODO: 4. Handle success (redirect/show message) or error response from backend
        alert("Order creation logic not implemented yet!");
    });


}); // End DOMContentLoaded
</script>
{% endblock %}
