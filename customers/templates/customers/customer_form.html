{# customers/templates/customers/customer_form.html #}

{% extends "base.html" %}
{% load auth_extras %} {# Load custom tags if used for conditional elements #}

{% block title %}{{ form_title }}{% endblock %}

{% block content %}
  <div class="row justify-content-center">
    <div class="col-md-9 col-lg-8"> {# Slightly wider column #}
      <h1 class="mb-4">{{ form_title }}</h1>
      <div class="card shadow-sm">
        <div class="card-body">
          {# Use POST method; novalidate disables browser validation #}
          {# No enctype needed unless customer form has file fields #}
          <form method="post" novalidate>
            {% csrf_token %} {# Security token required by Django #}

           {# --- Main Customer Details Card --- #}
        <div class="card shadow-sm mb-4">
          <div class="card-header">Customer Details</div>
          <div class="card-body">
              {# Explicit Phone Group #}
              <label class="form-label">Phone Number</label>
              <div class="input-group mb-3"> ... {{ form.country_code }} {{ form.phone_number }} ... </div>
              {# Phone Errors #}
              {% for error in form.country_code.errors %}<div ...></div>{% endfor %}
              {% for error in form.phone_number.errors %}<div ...></div>{% endfor %}

              {# Loop for other main form fields #}
              {% for field in form %}
                {% if field.name != 'country_code' and field.name != 'phone_number' %}
                  <div class="mb-3">
                      {{ field.label_tag }}
                      {% if field.name == 'groups' or field.name == 'location_tags' %}
                          <div class="border p-2 rounded" style="max-height: 150px; overflow-y: auto;">{{ field }}</div>
                      {% elif field.name == 'notes' %}
                          {{ field }}
                      {% else %}
                          {{ field }}
                      {% endif %}
                      {% if field.help_text %}<small ...>{{ field.help_text }}</small>{% endif %}
                      {% for error in field.errors %}<div ...>{{ error }}</div>{% endfor %}
                  </div>
                {% endif %}
              {% endfor %}
              {# --- End Main Customer Form Fields --- #}
          </div> {# End Card Body #}
        </div> {# End Card #}
        {# --- END Main Customer Details Card --- #}


        {# --- START: Render Address Inline Formset --- #}
        <div class="card shadow-sm mb-4">
            <div class="card-header">Addresses</div>
            <div class="card-body">
                 {{ address_formset.management_form }}
        {% if address_formset.non_form_errors %} ... {% endif %}

        {% for address_form in address_formset %}
            <div class="address-form mb-4 p-3 border rounded position-relative">
                 {{ address_form.id }}
                 {{ address_form.latitude }}
                 {{ address_form.longitude }}
                <div class="row g-3">
                    {# Address Line 1 #}
                    <div class="col-12">
                      {{ address_form.address_line.label_tag }}
                      {{ address_form.address_line }} {# Render the input field #}
                      {% for error in address_form.address_line.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %} {# Show errors #}
                 </div>
                  {# Landmark #}
                  <div class="col-md-6">
                      {{ address_form.landmark.label_tag }}
                      {{ address_form.landmark }}
                      {% for error in address_form.landmark.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                 </div>
                 {# Postal Code #}
                 <div class="col-md-6">
                      {{ address_form.postal_code.label_tag }}
                      {{ address_form.postal_code }}
                       {% for error in address_form.postal_code.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                 </div>
                     
                 <div class="col-12">
                  <label class="form-label">Pin Location on Map:</label>
                  {# Unique ID needed for each map instance in the formset #}
                  <div id="map-{{ address_form.prefix }}" class="leaflet-map-container border rounded"></div>
                  <small class="form-text text-muted">Click on the map to set Latitude/Longitude.</small>
                 </div>

                     {# --- ADD Location Tags rendering --- #}
                 <div class="col-12">
                     {% comment %} {{ address_form.location_tags.label_tag }} {% endcomment %}
                     {# Use the CheckboxSelectMultiple widget automatically now #}
                     <div class="d-flex justify-content-between align-items-center mb-1">
                      <label class="form-label mb-0">{{ address_form.location_tags.label }}:</label>
                      <button type="button" class="btn btn-outline-secondary btn-sm add-location-tag-btn" data-bs-toggle="modal" data-bs-target="#addLocationTagModal">
                          <i class="fas fa-plus"></i> Add New Tag
                      </button>
                 </div>

                 <div class="border p-2 rounded bg-light location-tags-container" style="max-height: 100px; overflow-y: auto;">
                  {{ address_form.location_tags }}
                 </div>

                   {% for error in address_form.location_tags.errors %} 
                    <div class="invalid-feedback d-block">{{ error }}</div> 
                   {% endfor %}
            </div>
                     {# --- END Location Tags --- #}

                     {# Is Primary & Delete #}
                     <div class="col-12 d-flex align-items-center justify-content-between"> {# Changed to col-12 #}
                        {# ... is_primary checkbox ... #}
                        {# ... DELETE checkbox ... #}
                     </div>
                </div>{# End row #}
             </div>{# End address-form wrapper #}
        {% endfor %} {# End loop through address forms #}
            </div> {# End Card Body #}
        </div> {# End Card #}
        {# --- END: Render Address Inline Formset --- #}


        {# --- Submit Buttons --- #}
        <div class="mt-4">
          <button type="submit" class="btn btn-success">
              {% if customer %}Update Customer{% else %}Save New Customer{% endif %}
          </button>
          <a href="{% if customer %}{% url 'customers:customer_detail' pk=customer.pk %}{% else %}{% url 'customers:customer_list' %}{% endif %}" class="btn btn-secondary">Cancel</a>
        </div>
        {# --- End Buttons --- #}

          </form> {# End Form #}
        </div> {# End card-body #}
      </div> {# End card #}
    </div> {# End col #}
  </div> {# End row #}

    {# --- ADD LOCATION TAG MODAL STRUCTURE --- #}
    <div class="modal fade" id="addLocationTagModal" tabindex="-1" aria-labelledby="addLocationTagModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addLocationTagModalLabel">Add New Location Tag</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
                {# Simple form inside modal #}
                <label for="new-location-tag-name" class="form-label">New Tag Name:</label>
                <input type="text" id="new-location-tag-name" class="form-control mb-2">
                <div id="location-tag-modal-error" class="text-danger small mt-1"></div> {# For errors #}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="save-new-location-tag-btn">Save Tag</button>
          </div>
        </div>
      </div>
    </div>
    {# --- END LOCATION TAG MODAL STRUCTURE --- #}
{% endblock %} {# End content block #}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("Customer Form JS loaded.");

    // --- Location Tag Modal Elements & Logic ---
    const addLocationTagModalEl = document.getElementById('addLocationTagModal');
    const newLocationTagNameInput = document.getElementById('new-location-tag-name');
    const saveNewLocationTagBtn = document.getElementById('save-new-location-tag-btn');
    const locationTagModalErrorDiv = document.getElementById('location-tag-modal-error');

    let addLocationTagModalInstance = null;
    if (addLocationTagModalEl) {
        addLocationTagModalInstance = new bootstrap.Modal(addLocationTagModalEl);
    }

    // Note: The "Add New Tag" buttons are inside the formset, so we might have multiple.
    // We handle opening the modal via data-bs-* attributes on the button itself.
    // We only need the listener for the SAVE button inside the modal.

    if (saveNewLocationTagBtn) {
        saveNewLocationTagBtn.addEventListener('click', function() {
            const newName = newLocationTagNameInput.value.trim();
            locationTagModalErrorDiv.textContent = ''; // Clear errors
            newLocationTagNameInput.classList.remove('is-invalid');

            if (!newName) {
                locationTagModalErrorDiv.textContent = 'Please enter a tag name.';
                newLocationTagNameInput.classList.add('is-invalid');
                return;
            }

            // Prepare data and get CSRF token
            const formData = new FormData();
            formData.append('name', newName);
            const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
            if (!csrfToken) { /* Handle missing CSRF */ return; }
            formData.append('csrfmiddlewaretoken', csrfToken);

            // Send data to API
            fetch("{% url 'customers:api_location_tag_add' %}", { // Use correct URL name
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': csrfToken }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLocationTagModalInstance.hide(); // Close modal

                    // --- Dynamically Add New Tag Checkbox ---
                    // Find ALL location tag containers (one per address form)
                    const tagContainers = document.querySelectorAll('.location-tags-container');
                    tagContainers.forEach(container => {
                        // Create the new checkbox and label elements
                        const newDiv = document.createElement('div');
                        newDiv.classList.add('form-check', 'form-check-inline'); // Inline styling

                        const newCheckbox = document.createElement('input');
                        newCheckbox.type = 'checkbox';
                        newCheckbox.classList.add('form-check-input');
                        newCheckbox.name = container.querySelector('input[type=checkbox]')?.name || 'location_tags'; // Use name from existing checkbox in this formset form
                        newCheckbox.value = data.tag_id;
                        newCheckbox.id = `id_${newCheckbox.name}_${container.querySelectorAll('input').length}`; // Create a unique-ish ID
                        newCheckbox.checked = true; // Check the new tag by default

                        const newLabel = document.createElement('label');
                        newLabel.classList.add('form-check-label');
                        newLabel.htmlFor = newCheckbox.id;
                        newLabel.textContent = data.tag_name;

                        newDiv.appendChild(newCheckbox);
                        newDiv.appendChild(newLabel);
                        container.appendChild(newDiv); // Add to the container
                    });
                    // --- End Dynamic Add ---

                } else {
                    locationTagModalErrorDiv.textContent = data.error || 'An unknown error occurred.';
                    newLocationTagNameInput.classList.add('is-invalid');
                }
            })
            .catch(error => {
                console.error("Error saving location tag:", error);
                locationTagModalErrorDiv.textContent = 'An unexpected error occurred.';
            });
        });
}

console.log("Initializing maps...");
const addressForms = document.querySelectorAll('.address-form');

addressForms.forEach((formWrapper, index) => { // Added index for default prefixing
    // Determine prefix (ensure robust finding)
     //let prefix = formWrapper.querySelector('input[id$="-id"]')?.id.replace('-id', '');
  
  
     let prefix = null;
     // Try finding the hidden ID input first (most reliable for existing forms)
     const idInput = formWrapper.querySelector('input[type="hidden"][name$="-id"]');
     if (idInput && idInput.name) {
         // Extract prefix from name like 'addresses-0-id' -> 'addresses-0'
         prefix = idInput.name.substring(0, idInput.name.lastIndexOf('-'));
     } else {
         // Fallback for NEW forms (extra forms added by formset)
         // These often don't have the -id input rendered initially
         // Check if it's a new form by looking for inputs without a value in the 'id' field if rendered
         // Or rely on the management form's prefix + index (less direct)
         // Let's try finding any input name and extracting the prefix pattern
         const anyInput = formWrapper.querySelector('input, select, textarea');
         if (anyInput && anyInput.name) {
              const match = anyInput.name.match(/^([a-zA-Z0-9\-_]+)-\d+-/); // Match prefix-number-
              if (match) {
                  prefix = anyInput.name.substring(0, anyInput.name.lastIndexOf('-')); // e.g., addresses-1
              }
         }
     }
  
  
{% comment %}   
     // Fallback if ID hidden field not found (e.g., new forms) - relies on Django's default prefixing
     if (!prefix && document.querySelector('input[name="addresses-TOTAL_FORMS"]')) {
         // Find the input that holds the index for this specific form
         const indexInput = formWrapper.querySelector(`input[name$="-id"]`); // Check again or other identifying field
         if (indexInput) {
            // Try extracting from name attribute if ID fails e.g., name="addresses-0-id"
            const nameMatch = indexInput.name.match(/addresses-(\d+)-id/);
            if (nameMatch) prefix = `addresses-${nameMatch[1]}`;
         }
         // If still no prefix found for a new form, default (might conflict if multiple new)
          if (!prefix) prefix = `addresses-${index}`; // Less reliable fallback based on loop order
     } 
     {% endcomment %}




     {% comment %} if (!prefix) {
         console.error("Could not determine formset prefix for map initialization on form:", formWrapper);
         return; // Skip this form if prefix is missing
     } {% endcomment %}


     if (!prefix) {
      // Attempt to find prefix from management form input - less robust
      const totalFormsInput = document.querySelector('input[name="addresses-TOTAL_FORMS"]');
      if (totalFormsInput) {
         // This won't give the specific index, just the base prefix 'addresses'
         // prefix = totalFormsInput.name.replace('-TOTAL_FORMS', '');
         // Cannot reliably get index this way without more complex DOM traversal
         console.error("Could not reliably determine formset prefix for map initialization on form:", formWrapper);
          return; // Skip this form
      } else {
           console.error("Cannot find TOTAL_FORMS input or determine prefix.");
           return;
      }
 }



    const mapId = `map-${prefix}`;
    const mapElement = formWrapper.querySelector(`#${mapId}`);
    // Target hidden inputs using name attribute with prefix
    const latInput = formWrapper.querySelector(`input[name="${prefix}-latitude"]`);
    const lonInput = formWrapper.querySelector(`input[name="${prefix}-longitude"]`);

    if (!mapElement || !latInput || !lonInput) {
        console.error(`Missing map elements for prefix ${prefix}. MapElement: ${!!mapElement}, LatInput: ${!!latInput}, LonInput: ${!!lonInput}`);
        return;
    }
    console.log(`Initializing map for prefix: ${prefix}`);

    let initialLat = latInput.value ? parseFloat(latInput.value) : 20.5937;
    let initialLon = lonInput.value ? parseFloat(lonInput.value) : 78.9629;
    let initialZoom = latInput.value ? 15 : 5;

    const map = L.map(mapId).setView([initialLat, initialLon], initialZoom);

    // --- Tile Layers & Control (Keep this as before) ---
    const osmTile = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { // <-- OSM URL
      maxZoom: 19,
      attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
  });
  const esriSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { // <-- Esri URL
    maxZoom: 19,
    attribution: 'Tiles © Esri — ...' // Shortened attribution
});
    esriSatellite.addTo(map);
    L.control.layers({"Satellite": esriSatellite, "Street Map": osmTile}).addTo(map);
    // --- End Tile Layers ---

    let marker = L.marker([initialLat, initialLon], { draggable: true }).addTo(map);

    marker.on('dragend', function(e) {
        const latlng = e.target.getLatLng();
        latInput.value = latlng.lat.toFixed(7);
        lonInput.value = latlng.lng.toFixed(7);
        console.log(`Marker dragged for ${prefix}:`, latInput.value, lonInput.value);
    });

    map.on('click', function(e) {
        const latlng = e.latlng;
        marker.setLatLng(latlng);
        latInput.value = latlng.lat.toFixed(7);
        lonInput.value = latlng.lng.toFixed(7);
        console.log(`Map clicked for ${prefix}:`, latInput.value, lonInput.value);
    });

    latInput.addEventListener('change', updateMapFromInputs);
    lonInput.addEventListener('change', updateMapFromInputs);

    function updateMapFromInputs() {
        const lat = parseFloat(latInput.value);
        const lon = parseFloat(lonInput.value);
        if (!isNaN(lat) && !isNaN(lon)) {
            const newLatLng = L.latLng(lat, lon);
            marker.setLatLng(newLatLng);
            map.panTo(newLatLng);
        }
    }
}); // End forEach addressForm
// --- END Map Integration Logic ---


}); // End DOMContentLoaded
</script>
{% endblock %}